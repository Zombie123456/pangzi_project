version: '3.4'
services:
  nginx:
    image: nginx:1.15.9
    networks:
      - reverse_proxy
    volumes:
      - logs:/var/log/nginx
      - cache:/etc/nginx/cache
    env_file:
      - ../env/.env
      - ../env/.nginx
    configs:
      - source: nginx_default_conf
        target: /etc/nginx/conf.d/default.conf
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        failure_action: rollback
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager
    ports:
      - target: 8000
        published: 8000
        mode: host

networks:
  reverse_proxy:

configs:
  nginx_default_conf:
    file: ../configs/nginx/default.conf

volumes:
  logs:
  cache: